# -*- coding: utf-8 -*-
"""Streamlit_Obesity.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1BqtGIu-tG61nto2XtG78o5TG9FH_xm7t
"""

!pip install streamlit
!pip install openpyxl
import streamlit as st
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix

st.title("üìä An√°lise de Obesidade com Machine Learning")

# --- 1. Carregar dados diretamente ---
dados = pd.read_excel("Obesity 5.0.xlsx")  # arquivo na mesma pasta
st.write("Pr√©via dos dados:", dados.head())

# --- 2. Preparar dados ---
dados['Altura'] = pd.to_numeric(dados['Altura'], errors='coerce')
dados.loc[dados['Altura'] > 3.0, 'Altura'] /= 100
dados['Altura'] = dados['Altura'].round(2)

dados['Peso'] = pd.to_numeric(dados['Peso'], errors='coerce')
dados.loc[dados['Peso'] > 400, 'Peso'] /= 1000
dados['Peso'] = dados['Peso'].astype(int)

dados['IMC'] = dados['Peso'] / (dados['Altura'] ** 2)

bins = [0, 18.5, 24.9, 29.9, 34.9, 39.9, np.inf]
labels = ['Abaixo do Peso','Peso Normal','Sobrepeso','Obesidade Grau I','Obesidade Grau II','Obesidade Grau III']
dados['Obesidade'] = pd.cut(dados['IMC'], bins=bins, labels=labels)

dados_encoded = pd.get_dummies(
    dados,
    columns=['G√™nero','Frequ√™ncia_Alimentar_Calorica','Comer_Entre_Refei√ß√µes','Consumo_Alcool'],
    drop_first=True
)

# --- 3. Treino/Teste ---
y = dados_encoded['Obesidade']
X = dados_encoded.drop(columns=['IMC','Obesidade'])

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)
y_pred = model.predict(X_test)

# --- Por qu√™ do modelo? ---

st.markdown(""" Optou-se pelo algoritmo Random Forest por se tratar de um problema de classifica√ß√£o supervisionada multiclasse, onde o objetivo √© prever diferentes n√≠veis de obesidade. O Random Forest se mostrou adequado porque lida bem com vari√°veis num√©ricas e categ√≥ricas, reduz o risco de overfitting ao combinar diversas √°rvores de decis√£o e permite identificar a import√¢ncia das vari√°veis na previs√£o. Al√©m disso, √© um modelo robusto e amplamente utilizado em problemas de sa√∫de e comportamento, garantindo boa acur√°cia e interpretabilidade. """)

# --- 4. Resultados ---
st.subheader("üìà Resultados do Modelo")
acuracia_raw = accuracy_score(y_test, y_pred)
st.write("Acur√°cia (valor bruto):", acuracia_raw)
st.write(f"Assertividade total (em porcentagem): {acuracia_raw * 100:.2f}%")
st.text("Relat√≥rio de Classifica√ß√£o:\n" + classification_report(y_test, y_pred))

# --- 5. Matriz de Confus√£o ---
st.subheader("üîç Matriz de Confus√£o")
fig, ax = plt.subplots(figsize=(8,6))
class_names = labels
conf_matrix = confusion_matrix(y_test, y_pred, labels=class_names)
sns.heatmap(conf_matrix, annot=True, fmt='d', cmap='Blues',
            xticklabels=class_names, yticklabels=class_names, ax=ax)
st.pyplot(fig)

st.markdown(""" A matriz de confus√£o revela que o modelo teve bom desempenho na classifica√ß√£o das categorias intermedi√°rias, como sobrepeso (93 acertos) e obesidade grau I (82 acertos), mas apresentou confus√µes entre categorias vizinhas, como peso normal e sobrepeso, ou obesidade grau I e II. Esses erros s√£o compreens√≠veis √† luz dos dados analisados. Distribui√ß√£o de idade: as faixas et√°rias m√©dias entre categorias vizinhas s√£o pr√≥ximas, especialmente entre sobrepeso e obesidade grau I, o que pode dificultar a distin√ß√£o pelo modelo. H√°bitos alimentares e de atividade f√≠sica: muitos indiv√≠duos com sobrepeso e obesidade grau I compartilham padr√µes semelhantes de consumo de alimentos cal√≥ricos e baixa pr√°tica de exerc√≠cios, o que reduz a separa√ß√£o entre classes. Diferen√ßas entre g√™neros: como os dados mostram que mulheres concentram-se mais em obesidade grau III e homens em sobrepeso e grau II, o modelo pode ter aprendido padr√µes mais claros para esses grupos, mas menos precisos para extremos ou faixas menos representadas. Essas rela√ß√µes indicam que os erros do modelo n√£o s√£o aleat√≥rios, mas refletem sobreposi√ß√µes reais nos dados. Isso refor√ßa a import√¢ncia de considerar vari√°veis complementares ‚Äî como estilo de vida, hist√≥rico familiar e consumo de vegetais ‚Äî para melhorar a acur√°cia nas classifica√ß√µes mais dif√≠ceis. """)

# --- Paleta personalizada ---
paleta_personalizada = {
    'Abaixo do Peso': 'lightgreen',
    'Peso Normal': 'green',
    'Sobrepeso': 'gold',
    'Obesidade Grau I': 'orange',
    'Obesidade Grau II': 'red',
    'Obesidade Grau III': 'darkred'
}

# --- 6. Distribui√ß√£o por g√™nero ---
st.subheader("üë© Distribui√ß√£o da Obesidade (Feminino)")
dados_feminino = dados[dados['G√™nero'] == 'Feminino']
contagem_feminino = dados_feminino['Obesidade'].value_counts().reindex(labels, fill_value=0)
fig, ax = plt.subplots(figsize=(10,5))
sns.barplot(
    x=contagem_feminino.index,
    y=contagem_feminino.values,
    palette=[paleta_personalizada[cat] for cat in contagem_feminino.index],
    order=labels,
    ax=ax
)
ax.set_title("Distribui√ß√£o da Obesidade entre Pessoas do G√™nero Feminino")
ax.set_ylabel("")
ax.set_yticks([])
for container in ax.containers:
    ax.bar_label(container, fmt='%d', label_type='edge', padding=3)
plt.xticks(rotation=45, ha='right')
st.pyplot(fig)

st.markdown(""" Entre mulheres, o maior n√∫mero de casos est√° na categoria de obesidade grau III, o que contrasta com os dados masculinos, onde essa categoria √© quase inexistente. Isso indica uma preval√™ncia mais alta de obesidade severa entre mulheres, o que exige aten√ß√£o especial em estrat√©gias de preven√ß√£o e interven√ß√£o precoce. """)

st.subheader("üë® Distribui√ß√£o da Obesidade (Masculino)")
dados_masculino = dados[dados['G√™nero'] == 'Masculino']
contagem_masculino = dados_masculino['Obesidade'].value_counts().reindex(labels, fill_value=0)
fig, ax = plt.subplots(figsize=(10,5))
sns.barplot(
    x=contagem_masculino.index,
    y=contagem_masculino.values,
    palette=[paleta_personalizada[cat] for cat in contagem_masculino.index],
    order=labels,
    ax=ax
)
ax.set_title("Distribui√ß√£o da Obesidade entre Pessoas do G√™nero Masculino")
ax.set_ylabel("")
ax.set_yticks([])
for container in ax.containers:
    ax.bar_label(container, fmt='%d', label_type='edge', padding=3)
plt.xticks(rotation=45, ha='right')
st.pyplot(fig)

st.markdown(""" A maior parte dos homens est√° concentrada nas categorias de sobrepeso e obesidade grau II, indicando que o excesso de peso √© predominante, mas os casos mais graves (grau III) s√£o raros. Isso sugere que, embora o problema seja amplo, ainda h√° espa√ßo para interven√ß√µes antes que evolua para quadros cl√≠nicos mais cr√≠ticos. """)

# --- 7. M√©dia de idade por categoria ---
st.subheader("üìä M√©dia de Idade por Categoria de Obesidade (Feminino)")
media_idade_fem = dados_feminino.groupby('Obesidade')['Idade'].mean().reindex(labels)
fig, ax = plt.subplots(figsize=(10,5))
sns.barplot(
    x=media_idade_fem.index,
    y=media_idade_fem.values,
    palette=[paleta_personalizada[cat] for cat in media_idade_fem.index],
    order=labels,
    ax=ax
)
ax.set_ylabel("M√©dia de Idade")
for container in ax.containers:
    ax.bar_label(container, fmt='%.1f', label_type='edge', padding=3)
plt.xticks(rotation=45, ha='right')
st.pyplot(fig)

st.markdown(""" A distribui√ß√£o da m√©dia de idade entre as categorias de obesidade feminina mostra uma progress√£o at√© a obesidade grau I, com pico de idade m√©dia em 27 anos. A partir da√≠, observa-se uma leve queda: mulheres com obesidade grau II t√™m m√©dia de 25 anos, e aquelas com obesidade grau III, 23 anos. Esse padr√£o sugere que os casos mais graves de obesidade est√£o se manifestando em mulheres mais jovens, o que pode indicar um in√≠cio precoce de h√°bitos alimentares inadequados, sedentarismo ou fatores metab√≥licos. """)

st.subheader("üìä M√©dia de Idade por Categoria de Obesidade (Masculino)")
media_idade_masc = dados_masculino.groupby('Obesidade')['Idade'].mean().reindex(labels)
fig, ax = plt.subplots(figsize=(10,5))
sns.barplot(
    x=media_idade_masc.index,
    y=media_idade_masc.values,
    palette=[paleta_personalizada[cat] for cat in media_idade_masc.index],
    order=labels,
    ax=ax
)
ax.set_ylabel("M√©dia de Idade")
for container in ax.containers:
    ax.bar_label(container, fmt='%.1f', label_type='edge', padding=3)
plt.xticks(rotation=45, ha='right')
st.pyplot(fig)

st.markdown(""" A distribui√ß√£o da m√©dia de idade entre as categorias de obesidade masculina revela padr√µes onde os homens com **obesidade grau II** apresentam a maior m√©dia de idade (28,4 anos), enquanto os com **obesidade grau III** t√™m a menor m√©dia (18,0 anos). Esse contraste pode indicar que os casos mais graves de obesidade est√£o se manifestando em indiv√≠duos mais jovens, o que √© preocupante do ponto de vista cl√≠nico e epidemiol√≥gico. Por outro lado, a progress√£o entre as categorias *peso normal*, *sobrepeso* e *obesidade grau I* mostra um aumento gradual da m√©dia de idade, sugerindo que o ganho de peso pode estar relacionado ao envelhecimento e √† mudan√ßa de h√°bitos ao longo do tempo. Esse padr√£o refor√ßa a import√¢ncia de interven√ß√µes precoces, especialmente entre jovens com obesidade grau III, que podem estar expostos a riscos metab√≥licos mais cedo e por mais tempo. A an√°lise tamb√©m destaca a necessidade de estrat√©gias diferenciadas por faixa et√°ria, considerando que os fatores associados √† obesidade podem variar conforme o est√°gio da vida. """)

